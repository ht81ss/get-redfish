import requests
import pandas as pd
from datetime import datetime
from requests.auth import HTTPBasicAuth
import urllib3

# SSLè­¦å‘Šã‚’ç„¡åŠ¹åŒ–
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# ğŸ”¹ èªè¨¼æƒ…å ±ï¼ˆServer1ã€œ12ã¯å…±é€šã®IDãƒ»PASSï¼‰
AUTH_CREDENTIALS = {
    **{f"Server{i}": HTTPBasicAuth("username", "password") for i in range(1, 13)},
    "CDU1": HTTPBasicAuth("username", "password"),
    "PDU1": None  # PDUã¯èªè¨¼ä¸è¦
}

# ğŸ”¹ å–å¾—å¯¾è±¡ã®ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆ
SERVERS = [
    *[{"name": f"Server{i}", "url": f"http://127.0.0.1:800{i}", "type": "temperature"} for i in range(1, 13)],
    {"name": "PDU1", "url": "http://127.0.0.1:9001", "type": "power"},
    {"name": "CDU1", "url": "http://127.0.0.1:9101", "type": "cdu"}
]

# ğŸ”¹ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­å®š
ENDPOINTS = {
    "temperature": "/redfish/v1/Chassis/1U/Thermal",
    "power": "/redfish/v1/Chassis/0/Power",
    "cdu": "/api/v1/telemetry"
}

# ğŸ”¹ CDU ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆå–å¾—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼ã‚’å®šç¾©ï¼‰
CDU_REQUEST_BODY = {
    "types": ["PrimaryTemperature", "PrimaryPressure", "PrimaryFlowRate"]
}

# ğŸ”¹ ã‚µãƒ¼ãƒãƒ¼ãƒ»PDU ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆGETï¼‰
def fetch_data_with_timeout(server):
    url = f"{server['url']}{ENDPOINTS[server['type']]}"
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    auth = AUTH_CREDENTIALS.get(server["name"], None)

    try:
        response = requests.get(url, verify=False, timeout=5, auth=auth)
        response.raise_for_status()
        return response.json(), url

    except requests.exceptions.RequestException as e:
        return [{
            "Timestamp": timestamp,
            "Device": server["name"],
            "IP": server["url"],
            "URL": url,
            "Type": "Error",
            "Name": "N/A",
            "Value": "N/A",
            "Unit": "N/A",
            "Error Message": str(e)
        }], url

# ğŸ”¹ CDU ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆPOSTï¼‰
def fetch_cdu_data(server):
    url = f"{server['url']}{ENDPOINTS[server['type']]}"
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    auth = AUTH_CREDENTIALS.get(server["name"], None)
    body = CDU_REQUEST_BODY  # äº‹å‰ã«å®šç¾©ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ä½¿ç”¨

    try:
        response = requests.post(url, json=body, verify=False, timeout=5, auth=auth)
        response.raise_for_status()
        return response.json(), url

    except requests.exceptions.RequestException as e:
        return [{
            "Timestamp": timestamp,
            "Device": server["name"],
            "IP": server["url"],
            "URL": url,
            "Type": "Error",
            "Name": "N/A",
            "Value": "N/A",
            "Unit": "N/A",
            "Error Message": str(e)
        }], url

# ğŸ”¹ ã‚µãƒ¼ãƒãƒ¼ã® CPU æ¸©åº¦ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
def extract_cpu_temperature(data, device_name, url):
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    results = []

    for sensor in data.get("Temperatures", []):
        if sensor.get("PhysicalContext") == "CPU":
            results.append({
                "Timestamp": timestamp,
                "Device": device_name,
                "URL": url,
                "Type": "Temperature",
                "Name": sensor.get("Name", "Unknown"),
                "Value": sensor.get("ReadingCelsius"),
                "Unit": "Celsius"
            })

    return results

# ğŸ”¹ PDU ã®æ¶ˆè²»é›»åŠ›ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
def extract_pdu_power(data, device_name, url):
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    results = []

    for power_ctrl in data.get("PowerControl", []):
        results.append({
            "Timestamp": timestamp,
            "Device": device_name,
            "URL": url,
            "Type": "Power",
            "Name": power_ctrl["Name"],
            "Value": power_ctrl["PowerConsumedWatts"],
            "Unit": "Watts"
        })

    return results

# ğŸ”¹ CDU ã®ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºï¼ˆäº‹å‰å®šç¾©ã®ã‚­ãƒ¼ã®ã¿å‡¦ç†ï¼‰
def extract_cdu_data(data, device_name, url):
    """CDU ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›"""
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    results = []

    if "type" in data:
        for key in CDU_REQUEST_BODY["types"]:  # äº‹å‰ã«å®šç¾©ã—ãŸã‚­ãƒ¼ã®ã¿å‡¦ç†
            if key in data["type"]:  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å‡¦ç†
                results.append({
                    "Timestamp": timestamp,
                    "Device": device_name,
                    "URL": url,
                    "Type": "CDU",
                    "Name": key,
                    "Value": data["type"][key],
                    "Unit": "Unknown"
                })

    return results

# ğŸ”¹ ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼†çµ±åˆ
def fetch_and_display_data():
    start_time = datetime.now().strftime("%Y%m%d_%H%M%S")
    csv_file = f"server_pdu_cdu_data_{start_time}.csv"

    all_data = []

    for server in SERVERS:
        if server["type"] == "cdu":
            data, url = fetch_cdu_data(server)
        else:
            data, url = fetch_data_with_timeout(server)

        if isinstance(data, list) and data and data[0].get("Type") == "Error":
            all_data.extend(data)
            continue

        if server["type"] == "temperature":
            all_data.extend(extract_cpu_temperature(data, server["name"], url))
        elif server["type"] == "power":
            all_data.extend(extract_pdu_power(data, server["name"], url))
        elif server["type"] == "cdu":
            all_data.extend(extract_cdu_data(data, server["name"], url))

    if not all_data:
        return pd.DataFrame()

    df = pd.DataFrame(all_data)
    df.to_csv(csv_file, index=False)
    return df

df = fetch_and_display_data()

import ace_tools as tools
tools.display_dataframe_to_user(name="Redfish Data", dataframe=df)
